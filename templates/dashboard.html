<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimiLancao OpenClaw Trader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: '#0a0e27',
                        card: '#1a1f3a',
                        border: '#2a3152',
                        'border-hover': '#3a4172',
                        muted: '#8b9dc3',
                        terminal: '#0f1419',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-dot { animation: pulse-dot 2s infinite; }
        /* keep log line classes for JS toggling */
        .log-line.info { color: #4caf50; }
        .log-line.error { color: #f44336; }
        .log-line.warning { color: #ff9800; }
    </style>
</head>
<body class="bg-base text-gray-200 font-sans p-3 sm:p-5">
    <div class="max-w-[1400px] mx-auto">

        <!-- Header -->
        <header class="text-center py-5 border-b-2 border-border mb-8">
            <h1 class="text-2xl sm:text-4xl font-bold mb-2">SimiLancao OpenClaw Trader</h1>
            <div class="mb-3">
                <a href="/backtest" class="text-muted hover:text-white text-sm transition-colors">Backtest &rarr;</a>
            </div>
            <span id="mode" class="inline-block px-4 py-1 rounded-full text-sm font-bold bg-blue-600 text-white">DRY-RUN</span>
        </header>

        <!-- Status / Balance / Position cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
            <div class="bg-card rounded-xl p-5 border border-border">
                <h2 class="text-sm text-muted mb-3">Status</h2>
                <div class="flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full bg-green-500 pulse-dot"></span>
                    <span id="status" class="text-lg font-semibold">Running</span>
                </div>
                <div class="text-gray-500 text-sm mt-2" id="last-update">Never</div>
            </div>
            <div class="bg-card rounded-xl p-5 border border-border">
                <h2 class="text-sm text-muted mb-3">Balance</h2>
                <div class="flex items-center justify-center gap-3">
                    <span id="balance" class="text-2xl sm:text-3xl font-bold text-green-500">0.00 USDT</span>
                    <span id="balance-toggle" class="cursor-pointer text-xl opacity-60 hover:opacity-100 select-none transition-opacity" title="Show/Hide Balance">ðŸ”’</span>
                </div>
            </div>
            <div class="bg-card rounded-xl p-5 border border-border">
                <h2 class="text-sm text-muted mb-3">Position</h2>
                <div id="position" class="text-2xl sm:text-3xl font-bold text-orange-400">None</div>
                <div id="position-pnl" class="text-base font-bold mt-2"></div>
            </div>
        </div>

        <!-- Trading Statistics -->
        <section class="mb-8">
            <h2 class="text-lg font-semibold text-muted mb-4">Trading Statistics</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="bg-card rounded-lg p-4 border border-border text-center">
                    <h3 class="text-xs text-muted mb-2">Total Trades</h3>
                    <div class="text-xl font-bold" id="total-trades">0</div>
                </div>
                <div class="bg-card rounded-lg p-4 border border-border text-center">
                    <h3 class="text-xs text-muted mb-2">Win Rate</h3>
                    <div class="text-xl font-bold" id="win-rate">0%</div>
                </div>
                <div class="bg-card rounded-lg p-4 border border-border text-center">
                    <h3 class="text-xs text-muted mb-2">Total PnL</h3>
                    <div class="text-xl font-bold" id="total-pnl">+0.00 USDT</div>
                </div>
                <div class="bg-card rounded-lg p-4 border border-border text-center">
                    <h3 class="text-xs text-muted mb-2">Avg PnL</h3>
                    <div class="text-xl font-bold" id="avg-pnl">+0.00 USDT</div>
                </div>
            </div>
        </section>

        <!-- Advisor Decisions -->
        <section class="mb-8">
            <h2 class="text-lg font-semibold text-muted mb-4">OpenClaw AI Advisor Decisions</h2>
            <div class="overflow-x-auto">
                <table class="w-full bg-card rounded-lg overflow-hidden text-sm">
                    <thead>
                        <tr class="bg-border text-muted text-xs">
                            <th class="p-3 text-left">Time</th>
                            <th class="p-3 text-left">Direction</th>
                            <th class="p-3 text-left">Entry Price</th>
                            <th class="p-3 text-left">Advisor SL</th>
                            <th class="p-3 text-left">Advisor TP</th>
                            <th class="p-3 text-left">Decision</th>
                            <th class="p-3 text-left">Executed</th>
                            <th class="p-3 text-left">Response Time</th>
                        </tr>
                    </thead>
                    <tbody id="advisor-body">
                        <tr><td colspan="8" class="p-4 text-center text-gray-500">No advisor decisions yet</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex items-center justify-center gap-3 mt-3">
                <button id="advisor-prev" onclick="changeAdvisorPage(-1)" class="px-4 py-1.5 bg-border text-gray-200 border border-border-hover rounded-md text-sm hover:bg-border-hover disabled:opacity-40 disabled:cursor-default">Prev</button>
                <span id="advisor-page-info" class="text-sm text-muted">Page 1 of 1</span>
                <button id="advisor-next" onclick="changeAdvisorPage(1)" class="px-4 py-1.5 bg-border text-gray-200 border border-border-hover rounded-md text-sm hover:bg-border-hover disabled:opacity-40 disabled:cursor-default">Next</button>
            </div>
        </section>

        <!-- Recent Trades -->
        <section class="mb-8">
            <h2 class="text-lg font-semibold text-muted mb-4">Recent Trades</h2>
            <div class="overflow-x-auto">
                <table class="w-full bg-card rounded-lg overflow-hidden text-sm">
                    <thead>
                        <tr class="bg-border text-muted text-xs">
                            <th class="p-3 text-left">Time</th>
                            <th class="p-3 text-left">Direction</th>
                            <th class="p-3 text-left">Entry</th>
                            <th class="p-3 text-left">Exit</th>
                            <th class="p-3 text-left">PnL</th>
                            <th class="p-3 text-left">PnL %</th>
                            <th class="p-3 text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        <tr><td colspan="7" class="p-4 text-center text-gray-500">No trades yet</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex items-center justify-center gap-3 mt-3">
                <button id="trades-prev" onclick="changeTradesPage(-1)" class="px-4 py-1.5 bg-border text-gray-200 border border-border-hover rounded-md text-sm hover:bg-border-hover disabled:opacity-40 disabled:cursor-default">Prev</button>
                <span id="trades-page-info" class="text-sm text-muted">Page 1 of 1</span>
                <button id="trades-next" onclick="changeTradesPage(1)" class="px-4 py-1.5 bg-border text-gray-200 border border-border-hover rounded-md text-sm hover:bg-border-hover disabled:opacity-40 disabled:cursor-default">Next</button>
            </div>
        </section>

        <!-- Logs -->
        <section class="bg-card rounded-xl p-5 border border-border">
            <h2 class="text-lg font-semibold text-muted mb-4">Recent Activity</h2>
            <div id="logs" class="bg-terminal rounded-md p-4 max-h-96 overflow-y-auto font-mono text-xs leading-relaxed">
                <div class="log-line">Loading logs...</div>
            </div>
        </section>
    </div>

    <!-- Advisor Detail Modal -->
    <div id="advisor-modal" class="hidden fixed inset-0 bg-black/70 z-50 items-center justify-center" onclick="closeModal(event)">
        <div class="bg-card border border-border rounded-xl p-6 max-w-lg w-[90%] max-h-[80vh] overflow-y-auto relative">
            <button class="absolute top-3 right-4 text-muted hover:text-white text-2xl" onclick="document.getElementById('advisor-modal').classList.add('hidden');document.getElementById('advisor-modal').classList.remove('flex')">&times;</button>
            <h3 class="text-muted font-semibold mb-4">Advisor Decision</h3>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Time</span><span class="font-bold text-sm" id="modal-time"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Direction</span><span class="font-bold text-sm" id="modal-direction"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Entry Price</span><span class="font-bold text-sm" id="modal-entry"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Bot SL / TP</span><span class="font-bold text-sm" id="modal-bot-sltp"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Advisor SL</span><span class="font-bold text-sm text-red-500" id="modal-advisor-sl"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Advisor TP</span><span class="font-bold text-sm text-green-500" id="modal-advisor-tp"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Decision</span><span class="font-bold text-sm" id="modal-decision"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Executed</span><span class="font-bold text-sm" id="modal-executed"></span></div>
            <div class="flex justify-between py-2 border-b border-border"><span class="text-muted text-sm">Response Time</span><span class="font-bold text-sm" id="modal-response"></span></div>
            <p class="text-muted text-sm mt-4 mb-2">Reason</p>
            <div id="modal-reason" class="bg-terminal rounded-lg p-4 text-sm leading-relaxed whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        let balanceVisible = localStorage.getItem('balanceVisible') === 'true';
        let actualBalance = 0;
        let advisorDecisionsCache = [];
        const PAGE_SIZE = 10;
        let tradesPage = 1, tradesTotalPages = 1;
        let advisorPage = 1, advisorTotalPages = 1;

        function toggleBalance() {
            balanceVisible = !balanceVisible;
            localStorage.setItem('balanceVisible', balanceVisible);
            updateBalanceDisplay();
            const btn = document.getElementById('balance-toggle');
            btn.textContent = balanceVisible ? 'ðŸ‘ï¸' : 'ðŸ”’';
            btn.title = balanceVisible ? 'Hide Balance' : 'Show Balance';
        }
        function updateBalanceDisplay() {
            const el = document.getElementById('balance');
            el.textContent = balanceVisible ? actualBalance.toFixed(2) + ' USDT' : 'â€¢â€¢â€¢.â€¢â€¢ USDT';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('balance-toggle');
            btn.textContent = balanceVisible ? 'ðŸ‘ï¸' : 'ðŸ”’';
            btn.title = balanceVisible ? 'Hide Balance' : 'Show Balance';
            btn.addEventListener('click', toggleBalance);
        });

        function changeTradesPage(d) { const p = tradesPage + d; if (p >= 1 && p <= tradesTotalPages) { tradesPage = p; fetchTrades(); } }
        function changeAdvisorPage(d) { const p = advisorPage + d; if (p >= 1 && p <= advisorTotalPages) { advisorPage = p; fetchAdvisorDecisions(); } }
        function updateTradesPagination() {
            document.getElementById('trades-page-info').textContent = `Page ${tradesPage} of ${tradesTotalPages}`;
            document.getElementById('trades-prev').disabled = tradesPage <= 1;
            document.getElementById('trades-next').disabled = tradesPage >= tradesTotalPages;
        }
        function updateAdvisorPagination() {
            document.getElementById('advisor-page-info').textContent = `Page ${advisorPage} of ${advisorTotalPages}`;
            document.getElementById('advisor-prev').disabled = advisorPage <= 1;
            document.getElementById('advisor-next').disabled = advisorPage >= advisorTotalPages;
        }

        function fetchTrades() {
            const offset = (tradesPage - 1) * PAGE_SIZE;
            fetch(`/api/trades/recent?limit=${PAGE_SIZE}&offset=${offset}`)
                .then(r => r.json())
                .then(data => {
                    tradesTotalPages = Math.max(1, Math.ceil((data.total || 0) / PAGE_SIZE));
                    if (tradesPage > tradesTotalPages) tradesPage = tradesTotalPages;
                    updateTradesPagination();
                    const tbody = document.getElementById('trades-body');
                    if (data.trades && data.trades.length > 0) {
                        tbody.innerHTML = data.trades.map(trade => {
                            const t = new Date(trade.entry_time).toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
                            const ep = trade.exit_price ? trade.exit_price.toFixed(1) : '-';
                            const pnl = trade.pnl !== null ? trade.pnl.toFixed(2) : '-';
                            const pp = trade.pnl_percentage !== null ? trade.pnl_percentage.toFixed(2) + '%' : '-';
                            const pc = trade.pnl !== null ? (trade.pnl >= 0 ? 'text-green-500' : 'text-red-500') : '';
                            const dc = trade.direction === 'LONG' ? 'bg-green-900 text-green-500' : 'bg-red-900 text-red-500';
                            const sc = trade.status === 'open' ? 'bg-blue-800 text-blue-400' : 'bg-gray-700 text-gray-400';
                            return `<tr class="hover:bg-[#252a45] border-t border-border">
                                <td class="p-3">${t}</td>
                                <td class="p-3"><span class="px-2 py-0.5 rounded text-xs font-bold ${dc}">${trade.direction}</span></td>
                                <td class="p-3">${trade.entry_price.toFixed(1)}</td>
                                <td class="p-3">${ep}</td>
                                <td class="p-3 ${pc}">${pnl !== '-' ? (trade.pnl >= 0 ? '+' : '') + pnl : '-'}</td>
                                <td class="p-3 ${pc}">${pp !== '-' ? (trade.pnl_percentage >= 0 ? '+' : '') + pp : '-'}</td>
                                <td class="p-3"><span class="px-2 py-0.5 rounded text-xs ${sc}">${trade.status.toUpperCase()}</span></td>
                            </tr>`;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No trades yet</td></tr>';
                    }
                }).catch(err => console.error('Error fetching trades:', err));
        }

        function fetchAdvisorDecisions() {
            const offset = (advisorPage - 1) * PAGE_SIZE;
            fetch(`/api/advisor/recent?limit=${PAGE_SIZE}&offset=${offset}`)
                .then(r => r.json())
                .then(data => {
                    advisorTotalPages = Math.max(1, Math.ceil((data.total || 0) / PAGE_SIZE));
                    if (advisorPage > advisorTotalPages) advisorPage = advisorTotalPages;
                    updateAdvisorPagination();
                    const tbody = document.getElementById('advisor-body');
                    if (data.decisions && data.decisions.length > 0) {
                        advisorDecisionsCache = data.decisions;
                        tbody.innerHTML = data.decisions.map((d, idx) => {
                            const ts = new Date(d.timestamp).toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
                            const dc = d.direction === 'LONG' ? 'bg-green-900 text-green-500' : 'bg-red-900 text-red-500';
                            const dec = d.approved ? '<span class="text-green-500">APPROVED</span>' : '<span class="text-red-500">REJECTED</span>';
                            const exec = d.trade_executed ? '<span class="px-2 py-0.5 rounded text-xs bg-blue-800 text-blue-400">YES</span>' : '<span class="px-2 py-0.5 rounded text-xs bg-gray-700 text-gray-400">NO</span>';
                            const rt = d.response_time_ms ? d.response_time_ms + 'ms' : '-';
                            return `<tr class="hover:bg-[#252a45] border-t border-border cursor-pointer" onclick="showAdvisorDetail(${idx})">
                                <td class="p-3">${ts}</td>
                                <td class="p-3"><span class="px-2 py-0.5 rounded text-xs font-bold ${dc}">${d.direction}</span></td>
                                <td class="p-3">${d.entry_price.toFixed(1)}</td>
                                <td class="p-3 text-red-500">${d.advisor_sl ? d.advisor_sl.toFixed(1) : '-'}</td>
                                <td class="p-3 text-green-500">${d.advisor_tp ? d.advisor_tp.toFixed(1) : '-'}</td>
                                <td class="p-3">${dec}</td>
                                <td class="p-3">${exec}</td>
                                <td class="p-3">${rt}</td>
                            </tr>`;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">No advisor decisions yet</td></tr>';
                    }
                }).catch(err => console.error('Error fetching advisor decisions:', err));
        }

        function updateDashboard() {
            fetch('/api/status').then(r => r.json()).then(data => {
                document.getElementById('status').textContent = data.status || 'Running';
                actualBalance = data.balance || 0;
                updateBalanceDisplay();
                document.getElementById('position').textContent = data.position || 'None';
                const pnlEl = document.getElementById('position-pnl');
                if (data.position_pnl) {
                    pnlEl.textContent = data.position_pnl;
                    pnlEl.style.color = data.position_pnl.includes('+') ? '#00c853' : '#ff1744';
                } else { pnlEl.textContent = ''; }
                const modeEl = document.getElementById('mode');
                modeEl.textContent = data.mode;
                modeEl.className = data.mode === 'LIVE'
                    ? 'inline-block px-4 py-1 rounded-full text-sm font-bold bg-red-600 text-white'
                    : 'inline-block px-4 py-1 rounded-full text-sm font-bold bg-blue-600 text-white';
                if (data.last_update) {
                    document.getElementById('last-update').textContent = 'Last update: ' + new Date(data.last_update).toLocaleTimeString();
                }
            }).catch(err => console.error('Error fetching status:', err));

            fetch('/api/logs').then(r => r.json()).then(data => {
                const el = document.getElementById('logs');
                if (data.logs && data.logs.length > 0) {
                    el.innerHTML = data.logs.map(line => {
                        let cls = 'log-line';
                        if (line.includes('[ERROR]')) cls += ' error';
                        else if (line.includes('[WARNING]')) cls += ' warning';
                        else if (line.includes('[INFO]')) cls += ' info';
                        return `<div class="${cls}">${escapeHtml(line)}</div>`;
                    }).join('');
                    el.scrollTop = el.scrollHeight;
                }
            }).catch(err => console.error('Error fetching logs:', err));

            fetch('/api/trades/statistics').then(r => r.json()).then(data => {
                document.getElementById('total-trades').textContent = data.total_trades || 0;
                document.getElementById('win-rate').textContent = (data.win_rate || 0).toFixed(1) + '%';
                const tp = data.total_pnl || 0;
                const tpEl = document.getElementById('total-pnl');
                tpEl.textContent = (tp >= 0 ? '+' : '') + tp.toFixed(2) + ' USDT';
                tpEl.className = 'text-xl font-bold ' + (tp >= 0 ? 'text-green-500' : 'text-red-500');
                const ap = data.avg_pnl || 0;
                const apEl = document.getElementById('avg-pnl');
                apEl.textContent = (ap >= 0 ? '+' : '') + ap.toFixed(2) + ' USDT';
                apEl.className = 'text-xl font-bold ' + (ap >= 0 ? 'text-green-500' : 'text-red-500');
            }).catch(err => console.error('Error fetching statistics:', err));

            if (tradesPage === 1) fetchTrades();
            if (advisorPage === 1) fetchAdvisorDecisions();
        }

        function showAdvisorDetail(idx) {
            const d = advisorDecisionsCache[idx];
            if (!d) return;
            const ts = new Date(d.timestamp).toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
            document.getElementById('modal-time').textContent = ts;
            document.getElementById('modal-direction').textContent = d.direction;
            document.getElementById('modal-entry').textContent = d.entry_price.toFixed(1);
            document.getElementById('modal-bot-sltp').textContent = d.stop_loss.toFixed(1) + ' / ' + d.take_profit.toFixed(1);
            document.getElementById('modal-advisor-sl').textContent = d.advisor_sl ? d.advisor_sl.toFixed(1) : '-';
            document.getElementById('modal-advisor-tp').textContent = d.advisor_tp ? d.advisor_tp.toFixed(1) : '-';
            document.getElementById('modal-decision').textContent = d.approved ? 'APPROVED' : 'REJECTED';
            document.getElementById('modal-executed').textContent = d.trade_executed ? 'Yes' : 'No';
            document.getElementById('modal-response').textContent = d.response_time_ms ? d.response_time_ms + 'ms' : '-';
            document.getElementById('modal-reason').textContent = d.advisor_reason || '-';
            const modal = document.getElementById('advisor-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(event) {
            if (event.target === event.currentTarget) {
                event.target.classList.add('hidden');
                event.target.classList.remove('flex');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        fetchTrades();
        fetchAdvisorDecisions();
        updateDashboard();
        setInterval(updateDashboard, 2000);
    </script>
</body>
</html>
